---
title: "Shape-constrained models for functional responses"
author: Ben Bolker
date: ?? July 2024
bibliography: isec2024.bib
csl: reflist2.csl
output:
  ioslides_presentation
citation-package: biblatex
header-includes:
- \usepackage[authordate, backend=biber]{biblatex-chicago}
- \usepackage{amsmath}
- \usepackage{amssymbol}
- \newcommand{\y}{\boldsymbol y}
- \newcommand{\X}{\boldsymbol X}
- \newcommand{\Z}{\boldsymbol Z}
- \newcommand{\bbeta}{\boldsymbol \beta}
- \newcommand{\bb}{\boldsymbol b}
- \newcommand{\bu}{\boldsymbol u}
- \newcommand{\bLambda}{\boldsymbol \Lambda}
- \newcommand{\bEta}{\boldsymbol \eta}
- \newcommand{\btheta}{\boldsymbol \theta}
- \newcommand{\bzero}{\boldsymbol 0}
---

<style>
.refs {
   font-size: 14px;
}
h2 { 
 color: #3399ff;		
}
h3 { 
 color: #3399ff;		
}
.title-slide {
   background-color: #55bbff;
}

.pre {
  height: 30pc;
  overflow-y: scroll;
}

<!-- https://stackoverflow.com/questions/50378349/force-column-break-in-rmarkdown-ioslides-columns-2-layout -->
.forceBreak { -webkit-column-break-after: always; break-after: column; }
</style>

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, dpi = 200, optipng = knitr::hook_optipng)
options(bitmapType = "cairo")
```

```{r pkgs, message = FALSE}
library(knitr)
library(ggplot2); theme_set(theme_bw(base_size=16))
library(scam)
library(mgcv)
library(tidyverse)
```

## modeling tradeoffs

@levinsStrategy1966 proposed that models faced a tradeoff among **realism**, **precision**, and **generality**

1. realism and precision [engineering: "tactical" models]
2. precision and generality [physics/"spherical cow": Lotka-Volterra style]
3. realism and generality [math]

see also @alday1978

<!-- https://tex.stackexchange.com/questions/544666/how-to-cite-a-song-in-a-bib-file -->
<!-- https://tex.stackexchange.com/questions/449191/using-biblatex-with-r-markdown -->

## parametric models

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 50px;"}

::: {}

- precise, more realistic, less general
- often choose from large family of options
- very particular assumptions
   - e.g. power-logistic vs. $t$-distribution
- interpretable/testable parameters

:::

::: {}

@quinnQuantitative1999

```{r param-models, out.width=350}
knitr::include_graphics("pix/quinnderiso.png")
```

:::

::::

## realism via nonparametric models

* curves

## semiparametric models

@ellnerNoise1998b, @woodPartially2001

## shape-constrained models


## bases

```{r bases, echo = FALSE, out.width = "100%"}
set.seed(101)
dd <- data.frame(x=seq(-5, 5, length = 101))
dd <- within(dd, {
             mu <- 1 + x - x^3/4
             y <- rnorm(length(mu), mu, sd = 1)
             })
sm0 <- smoothCon(s(x, bs = "tp"), data = dd, absorb.cons = TRUE)[[1]]
sm1 <- smoothCon(s(x, bs = "mpd"), data = dd, absorb.cons = TRUE)[[1]]
sm2 <- smoothCon(s(x, bs = "ps"), data = dd, absorb.cons = TRUE)[[1]]
colvec <- palette.colors(n=8)
pfun <- function(x, main) {
    matplot(x, type = "l", main = main, col = colvec, ylab = "", xlab = "",
            lwd = 2)
}
par(mfrow=c(1,2), las = 1, bty = "l")
pfun(sm2$X, "P-spline")
pfun(sm1$X, "Monotonic p-spline")
```


## reed frog example (raw data)

```{r get_rf}
L <- load("reedfrog_stuff.rda")
```

```{r rf-raw, out.width = "70%"}
pf <- (pred_frame
    |> filter(model == "mle2_holling")
    |> mutate(across(c(prob, lwr, upr), ~. * Initial))
)
ggplot(pf, aes(x = Initial)) +
    geom_line(aes(y = prob)) +
    geom_ribbon(aes(ymin = lwr, ymax = upr), colour = NA, fill = "black", alpha = 0.3) +
    expand_limits(y=0) +
    geom_point(data=dd, aes(y = Killed, size = Killed), alpha = 0.5) +
    labs(y = "Number predated")
```

## reed frog example (fits)

```{r fit-plot, out.width = "100%"}
pf <- pred_frame |> filter(model != "RTMB_mpd")
pred_plot <- function(var, data = pred_frame) {
    var <- enquo(var)
    gg0 <- ggplot(data, aes(Initial, prob)) +
        geom_line(aes(colour = !!var)) +
        geom_ribbon(aes(ymin = lwr, ymax = upr, fill = !!var), colour = NA, alpha = 0.5) +
        expand_limits(y=0) +
        geom_point(data=dd, aes(y = Killed/Initial, size = Killed), alpha = 0.5) +
        facet_wrap(vars(!!var)) +
        theme(legend.position = "none")
    return(gg0)
}
pred_plot(model, pf)
```

## goodness of fit

```{r aictab1}
pander::pander(rf_aictab, digits = 2)
```

## size/density interactions

```{r wb-0, out.width="60%"}
knitr::include_graphics("pix/wb_plotly_0.png")
```

## mechanistic fit

attack rate = Ricker, handling time = prop to size

```{r wb-param, out.width="60%"}
knitr::include_graphics("pix/wb_plotly_param.png")
```

## GAM fit

```{r wb-gam, out.width="60%"}
knitr::include_graphics("pix/wb_plotly_gam.png")
```

## shape-constrained fit

```{r wb-scam, out.width="60%"}
knitr::include_graphics("pix/wb_plotly_scam.png")
```

## goal/loose ends

* make shape-constrained bases more generally available  
(e.g. as components of more complex/semimechanistic models)
    * RTMB
	* glmmTMB?
* flush out bugs in `scam`/make `RTMB` fitting more robust	
* expand set of possible constraints (e.g. unimodal functions)

<!-- https://bookdown.org/yihui/rmarkdown-cookbook/multi-column.html -->

<!--
:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 50px;"}

::: {}

:::

::: {}

```{r, out.width=300, out.height=300}
## knitr::include_graphics("pix/dependency_2x.png")
```

:::

::::
-->



## references {.refs .columns-2 .pre}

